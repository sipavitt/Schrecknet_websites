<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Redirecting…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<script>
/* =========================================================
   CONFIG
========================================================= */

const INWORLD_CSV = "inworld_sites.csv";

/* =========================================================
   CSV LOADER (hardened)
========================================================= */

function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);

  const headers = lines.shift()
    .split(",")
    .map(h =>
      h.replace(/^\uFEFF/, "").trim().toLowerCase()
    );

  return lines.map(line => {
    const values = [];
    let current = "";
    let inQuotes = false;

    for (const ch of line) {
      if (ch === '"') { inQuotes = !inQuotes; continue; }
      if (ch === "," && !inQuotes) {
        values.push(current);
        current = "";
        continue;
      }
      current += ch;
    }
    values.push(current);

    const obj = {};
    headers.forEach((h, i) => {
      obj[h] = (values[i] || "").trim();
    });
    return obj;
  });
}

async function loadCSV(path) {
  try {
    const res = await fetch(path);
    if (!res.ok) return [];
    const text = await res.text();
    return parseCSV(text);
  } catch {
    return [];
  }
}

/* =========================================================
   HELPERS
========================================================= */

function normalise(value) {
  return (value || "")
    .trim()
    .toLowerCase()
    .replace(/^https?:\/\//, "")
    .replace(/\/+$/, "");
}

function isDomainLike(value) {
  return /^[a-z0-9.-]+\.[a-z]{2,}$/i.test(value);
}

function logClick(payload) {
  fetch("https://script.google.com/macros/s/AKfycbyBCC_DBGloXOATNP4l756HCQVL5AW_LezexKMjeC51nN7KGG4NO4fHJqHiBlsn0Js/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).catch(() => {});
}

  
/* =========================================================
   MAIN REDIRECT LOGIC
========================================================= */

(async function redirect() {
  const rawU = new URLSearchParams(window.location.search).get("u");

  if (!rawU) {
    location.replace("index.html");
    return;
  }

  const uNorm = normalise(rawU);

  // Load in-world definitions
  const inworldSites = await loadCSV(INWORLD_CSV);

  // Build lookup table → canonical internal path
  const lookup = new Map();

  for (const site of inworldSites) {
    const path = (site.path || "").trim();
    if (!path) continue;

    const keys = [
      site.id,
      site.path,
      site.display_url,
      site.title
    ];

    keys.forEach(k => {
      const key = normalise(k);
      if (key) lookup.set(key, path);
    });

    // Also accept path without leading slash
    lookup.set(normalise(path.replace(/^\//, "")), path);
  }

  /* ---------------------------------------------
     1) In-world match
  --------------------------------------------- */
  if (lookup.has(uNorm)) {
    logClick({
  event: "click",
  target: lookup.get(uNorm),
  type: "inworld",
  source: document.referrer,
  user_agent: navigator.userAgent
});
    location.replace(lookup.get(uNorm));
    return;
  }

  /* ---------------------------------------------
     2) Full URL provided
  --------------------------------------------- */
  if (/^https?:\/\//i.test(rawU.trim())) {
    logClick({
  event: "click",
  target: rawU.trim(),
  type: "external",
  source: document.referrer,
  user_agent: navigator.userAgent
});
    location.replace(rawU.trim());
    return;
  }

  /* ---------------------------------------------
     3) Domain-like external
  --------------------------------------------- */
  if (isDomainLike(uNorm)) {
    logClick({
  event: "click",
  target: "https://" + uNorm,
  type: "external",
  source: document.referrer,
  user_agent: navigator.userAgent
});
    location.replace("https://" + uNorm);
    return;
  }

  /* ---------------------------------------------
     4) Fallback
  --------------------------------------------- */
  location.replace("index.html");
})();
</script>

<noscript>
  <p>Redirecting…</p>
</noscript>

</body>
</html>

