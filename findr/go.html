<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Redirectingâ€¦</title>
</head>
<body>

<script>
/* =========================================================
   CONFIG
========================================================= */

const INWORLD_CSV = "inworld_sites.csv";

/* =========================================================
   CSV LOADER (same logic as results.html)
========================================================= */

function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines.shift().split(",");

  return lines.map(line => {
    const values = [];
    let current = "";
    let inQuotes = false;

    for (let char of line) {
      if (char === '"') {
        inQuotes = !inQuotes;
        continue;
      }
      if (char === "," && !inQuotes) {
        values.push(current);
        current = "";
        continue;
      }
      current += char;
    }
    values.push(current);

    const obj = {};
    headers.forEach((h, i) => obj[h] = (values[i] || "").trim());
    return obj;
  });
}

async function loadCSV(path) {
  try {
    const res = await fetch(path);
    if (!res.ok) return [];
    const text = await res.text();
    return parseCSV(text);
  } catch {
    return [];
  }
}

/* =========================================================
   MAIN REDIRECT LOGIC
========================================================= */

(async function redirect() {
  const u = new URLSearchParams(location.search).get("u");

  if (!u) {
    location.href = "index.html";
    return;
  }

  // Load in-world sites
  const inworldSites = await loadCSV(INWORLD_CSV);

  // 1. Internal in-world match (path)
  const internal = inworldSites.find(site => site.path === u);

  if (internal) {
    location.href = internal.path;
    return;
  }

  // 2. External domain (noise site)
  if (/^[\w.-]+\.[A-Za-z]{2,}$/.test(u)) {
    location.href = "https://" + u;
    return;
  }

  // 3. Fallback
  location.href = "index.html";
})();
</script>

</body>
</html>
